# AI 键功能 PRD

## 1. 概述

AI 键是一个快捷键功能，允许用户通过语音快速向 AI 助手（如 ChatGPT、豆包等）发送问题。

## 2. 用户故事

**作为一个用户，我希望：**
- 长按一个快捷键（默认 Shift）
- 自动打开 AI 网站
- 说出我的问题
- 松开按键后，问题自动输入到 AI 网站的输入框并发送

**痛点：**
- 手动打开浏览器、输入网址、点击输入框、打字太慢
- 想要像和真人对话一样，按住说话，松开发送

## 3. 核心问题分析

### 3.1 当前实现的问题

```
按下 Shift → 打开网页 → 等待2秒 → 开始录音 → 松开 → 停止录音
```

**问题：**
1. 用户按住 Shift 时，浏览器可能无法正常加载（Shift 键影响浏览器行为）
2. 录音在按下后 2 秒才开始，但用户可能已经开始说话
3. 等待时间固定 2 秒，网络慢时页面可能还没加载完
4. 用户体验不自然：按下后要等，不知道什么时候开始说

### 3.2 理想的交互流程

用户的心智模型应该是：**"按住说话，松开发送"**

但现实约束：
- 打开浏览器需要时间
- 页面加载需要时间
- 语音识别需要时间

## 4. 设计方案

### 4.1 交互流程设计

```
┌─────────────────────────────────────────────────────────────────┐
│                        AI 键交互流程                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│  [长按 Shift 达到阈值]                                            │
│         │                                                         │
│         ▼                                                         │
│  ┌─────────────────┐                                             │
│  │ 1. 开始录音      │  ← 立即开始，不等待                          │
│  │ 2. 显示录音窗口  │                                             │
│  │ 3. 后台打开浏览器│  ← 异步执行，不阻塞录音                      │
│  └─────────────────┘                                             │
│         │                                                         │
│         │ (用户说话中...)                                         │
│         │                                                         │
│  [松开 Shift]                                                     │
│         │                                                         │
│         ▼                                                         │
│  ┌─────────────────┐                                             │
│  │ 4. 停止录音      │                                             │
│  │ 5. 显示识别中... │                                             │
│  └─────────────────┘                                             │
│         │                                                         │
│         │ (语音识别中...)                                         │
│         │                                                         │
│         ▼                                                         │
│  ┌─────────────────┐                                             │
│  │ 6. 识别完成      │                                             │
│  │ 7. 等待页面就绪  │  ← 检查浏览器是否已加载                      │
│  │ 8. 输入文字      │                                             │
│  │ 9. 按回车发送    │                                             │
│  └─────────────────┘                                             │
│                                                                   │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 关键设计决策

**决策 1：录音和打开浏览器并行执行**
- 按下时立即开始录音（用户体验优先）
- 同时异步打开浏览器（不阻塞录音）
- 好处：用户可以立即开始说话，无需等待

**决策 2：识别完成后再输入文字**
- 给浏览器足够的加载时间（用户说话 + 识别的时间）
- 输入前检测/等待页面就绪
- 好处：避免页面未加载完就输入

**决策 3：不使用 Shift 键作为默认热键**
- Shift 键在浏览器中有特殊含义（打开新窗口等）
- 建议默认使用 `alt` 或 `F2` 等不冲突的键
- 用户仍可自定义选择 Shift

## 5. 详细设计

### 5.1 状态机

```
                    ┌──────────┐
                    │  IDLE    │
                    └────┬─────┘
                         │ on_press
                         ▼
                    ┌──────────┐
          ┌────────│ RECORDING│←────────┐
          │        └────┬─────┘         │
          │             │ on_release    │ error
          │             ▼               │
          │        ┌──────────┐         │
          │        │RECOGNIZING├────────┘
          │        └────┬─────┘
          │             │ recognition_done
          │             ▼
          │        ┌──────────┐
          │        │ INPUTTING│
          │        └────┬─────┘
          │             │ input_done
          │             ▼
          └────────►┌──────────┐
                    │  IDLE    │
                    └──────────┘
```

### 5.2 时序图

```
用户          Speaky           浏览器          语音引擎
 │              │                │                │
 │──长按Shift──►│                │                │
 │              │                │                │
 │              │──打开URL──────►│                │
 │              │                │──加载页面──    │
 │              │──开始录音─────────────────────►│
 │              │◄─显示录音窗口─                  │
 │              │                │                │
 │ (说话...)    │                │                │
 │              │──发送音频─────────────────────►│
 │              │                │                │
 │──松开Shift──►│                │                │
 │              │──停止录音─────────────────────►│
 │              │◄─识别中...───                  │
 │              │                │                │
 │              │                │                │◄──识别处理
 │              │◄─────────────────识别结果─────│
 │              │                │                │
 │              │                │◄──页面就绪──   │
 │              │──输入文字─────►│                │
 │              │──按回车───────►│                │
 │              │                │──发送消息──►   │
 │              │                │                │
```

### 5.3 页面兼容性

| 网站 | URL | 输入框特点 | 回车行为 |
|------|-----|-----------|---------|
| ChatGPT | chatgpt.com | 自动聚焦 | 发送 |
| 豆包 | doubao.com/chat | 自动聚焦 | 发送 |
| Claude | claude.ai | 自动聚焦 | 发送 |
| Kimi | kimi.moonshot.cn | 自动聚焦 | 发送 |

大多数 AI 网站都会自动聚焦输入框，且回车即发送。

### 5.4 等待策略

由于无法精确检测页面是否加载完成，采用以下策略：

1. **最小等待时间**：从打开浏览器开始计时，至少等待 3 秒
2. **智能等待**：`max(3秒, 识别完成时间)` 后再输入
3. **用户可配置**：提供"页面加载等待时间"设置项

```python
# 时间线示例
T=0s:    按下热键，开始录音，打开浏览器
T=2s:    用户说完，松开热键，停止录音
T=2.5s:  语音识别完成，文字就绪
T=3s:    最小等待时间到，开始输入文字
T=3.2s:  输入完成，按回车
```

## 6. 配置项

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| ai_enabled | true | 是否启用 AI 键 |
| ai_hotkey | "alt" | AI 键热键（建议避免 shift） |
| ai_hotkey_hold_time | 0.5 | 长按触发时间（秒） |
| ai_url | "https://chatgpt.com" | AI 网站地址 |
| ai_page_load_delay | 3.0 | 页面加载等待时间（秒） |
| ai_auto_enter | true | 是否自动按回车发送 |

## 7. 实现要点

### 7.1 核心改动

```python
def _on_ai_hotkey_press(self):
    """AI 键按下：同时开始录音和打开浏览器"""
    self._ai_mode = True
    self._ai_browser_open_time = time.time()  # 记录打开时间

    # 1. 立即开始录音（用户体验优先）
    self._on_start_recording()

    # 2. 异步打开浏览器（不阻塞）
    webbrowser.open(ai_url)

def _on_ai_recognition_done(self, text: str):
    """识别完成：等待页面就绪后输入"""
    # 计算还需等待多长时间
    elapsed = time.time() - self._ai_browser_open_time
    remaining = max(0, PAGE_LOAD_DELAY - elapsed)

    # 等待后输入
    QTimer.singleShot(int(remaining * 1000), lambda: self._ai_input_text(text))

def _ai_input_text(self, text: str):
    """输入文字并发送"""
    input_method.type_text(text)
    if config.get("ai_auto_enter", True):
        QTimer.singleShot(200, self._press_enter)
```

### 7.2 热键建议

修改默认热键从 `shift` 改为 `alt`，避免与浏览器冲突。

## 8. 测试用例

| # | 场景 | 预期结果 |
|---|------|---------|
| 1 | 长按 Alt，说"你好"，松开 | 打开 ChatGPT，输入"你好"，自动发送 |
| 2 | 快速按放 Alt（<0.5秒） | 不触发（未达到长按阈值） |
| 3 | 长按但不说话 | 打开网页，不输入任何内容 |
| 4 | 网络慢，页面加载超过3秒 | 等待识别完成后立即输入（页面应已加载） |
| 5 | 切换到豆包 URL | 同样流程，在豆包输入 |

## 9. 后续优化（可选）

1. **智能检测页面就绪**：通过辅助工具检测浏览器焦点
2. **多网站适配**：针对不同网站的输入框定位
3. **快捷短语**：预设常用提问前缀
4. **连续对话**：识别完成后保持监听，继续对话
